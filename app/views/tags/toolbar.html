<div id="toolbar">
	<div class="layer upper-layer">
		<a id="multi-ed-btn" class="btn btn-info toolbar-btn">Mark multiple students</a>
	</div>
	<div class="layer lower-layer hidden">
		<a id="sel-all-btn" class="btn btn-info">Select all</a>
		<a id="multi-sel-btn" class="btn btn-success" data-toggle="modal" data-target="#attend-edit-model">Choose award</a>
		<a id="cancel-btn" class="btn btn-default toolbar-btn">Cancel</a>
	</div>
</div>

<script type="text/javascript">
	$(function(){
		$('.toolbar-btn').on('click', function(){
			hideToolBar();
		});
		
		$('#sel-all-btn').on('click',function(){
			$('.multi-cb > input:checkbox').each(function(){
				$(this).prop('checked', true);
			});
		});
		
		$('ul.attend-list li').click(function(e) {
			var mulCbs = $('.multi-cb > input:checkbox');
			var childIds = [];
			$('.multi-cb > input:checkbox').each(function(){
				if($(this).is(':checked')){
					childIds.push($(this).attr('id').replace('cb-', ''));
				}
			});
			
			var settings = {};
			if(childIds.length == 0){
				var childId = $('.ch-att-sel').attr('id');
				childId = childId.substring(7, childId.length);
				
				settings.url = "/classlifecontroller/markAttendToChildByChildId";
				settings.data = {
							childId: childId,
		                	status: $(this).find('input').val()
	                	};
			}else{
				settings.url = "/classlifecontroller/markAttendToChildrenByChildIds";
				settings.data = {
							childIds: childIds,
		                	status: $(this).find('input').val()
	                	};
			}
			settings.method = "POST";
			
			sendRequent(
					function(response, status) {
		            	if(status == "success"){
		            		updateHtml((childIds.length > 0), response, e.target);
		            	}
		            	$('#attend-edit-model').modal('hide');
		            },
		            function (error) {
		            	console.log(error);
	                }, 
	                settings
            );
	    });
	});
	
	function updateHtml(isMulti, response, ele){
		if(isMulti){
			var mulCbs = $('.multi-cb > input:checkbox::checked');
			mulCbs.each(function(){
				updateAttendIcon($(this).parent().prev(), ele.innerHTML);
				$(this).prop('checked', false);
			});
			hideToolBar();
		}else{
			var attendance = jQuery.parseJSON(JSON.stringify(response));
			var ele = $('.ch-att-sel').find('.ch-att-content');
			updateAttendIcon(ele, attendance.status.substring(0, 1));
		}
	}
	
	function updateAttendIcon(ele, status){
		alert(ele.prop('tagName'), status);
		ele.removeAttr('class');
		if(status === "P"){
			ele.addClass('round-item-txt ch-att-content color-present');
			ele.text('P');
		}else if(status === "L"){
			ele.addClass('round-item-txt ch-att-content color-late');
			ele.text('L');
		}else if(status === "A"){
			ele.addClass('round-item-txt ch-att-content color-absent');
			ele.text('A');
		}else if(status === "M"){ 
			ele.addClass('round-item-txt ch-att-content color-mc');
			ele.text('M');
		}
	}
	
	function hideToolBar(){
		$('.layer').toggleClass('hidden');
		$('.multi-cb').toggleClass('hidden');
		if($('.upper-layer').hasClass('hidden')){
			$('.ch-att-content').off('click');
		}else{
			$('.ch-att-content').on('click', function(){
				$('.ch-att-sel').removeClass('ch-att-sel');
				$(this).parent().addClass('ch-att-sel');
				$('#attend-edit-model').modal('show');
			});
		}
	}
	
	function sendRequent(successCallback, errorCallback, settings){
		$.ajax({
            url: settings.url,
            type: settings.method,
            data : settings.data,
            success: successCallback,
            error: errorCallback
        });
	}
</script>
